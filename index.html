<!doctype html>
<meta charset="utf-8">
<title>Knowledge Centre — Upload</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:24px;max-width:900px}
  .card{border:1px solid #eee;border-radius:12px;padding:14px;margin:16px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  input,select,textarea,button{padding:10px;border:1px solid #ddd;border-radius:8px}
  input,select,textarea{width:100%}
  button{cursor:pointer;background:#fff}
  label{font-weight:600;margin-top:8px;display:block}
  .muted{opacity:.75}
  .ok{color:#117a2e}
  .err{color:#b00020}
  .small{font-size:.9rem}
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<h1>Upload a document</h1>

<div id="auth" class="card">
  <p><strong>Sign in</strong> with your work email to upload.</p>
  <div class="row">
    <input id="email" placeholder="you@company.com">
    <button onclick="login()">Send sign‑in link</button>
  </div>
  <p class="muted small">You’ll get a magic link. Open it on this device; you’ll return here signed in.</p>
  <p id="authMsg"></p>
</div>

<div id="uploader" class="card" style="display:none">
  <div class="row">
    <div style="flex:1;min-width:240px">
      <label>Attach to</label>
      <select id="attachType" onchange="resetPicker()">
        <option value="counterparty">Company</option>
        <option value="procedure">Procedure</option>
      </select>
    </div>
    <div style="flex:1;min-width:240px">
      <label>When filename already exists</label>
      <select id="conflictMode">
        <option value="append">Append (keep both)</option>
        <option value="overwrite">Overwrite existing</option>
        <option value="duplicate">Duplicate (add suffix)</option>
      </select>
    </div>
  </div>

  <label>Search name</label>
  <input id="searchInput" placeholder="Start typing company or procedure name…" oninput="searchNames()">
  <div class="muted small" id="pickInfo">Pick an item below.</div>
  <select id="pickId" size="6" style="width:100%"></select>

  <label>Document name (how it appears in the list)</label>
  <input id="docName" placeholder="e.g., KYC Form, Master Agreement, Bill of Lading">

  <label>Notes (optional)</label>
  <textarea id="notes" rows="3" placeholder="Any context or expiry date"></textarea>

  <label>File</label>
  <input id="file" type="file" />

  <div class="row" style="margin-top:12px">
    <button onclick="doUpload()">Upload & save</button>
  </div>
  <p id="msg"></p>
</div>

<script>
/* --- Your project details --- */
const supabase = supabasejs.createClient(
  "https://pajwufsizrmwkjveywyh.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBhand1ZnNpenJtd2tqdmV5d3loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MjEyNjIsImV4cCI6MjA3MDQ5NzI2Mn0.atSQj2ekJo_fePOOhMjbzRav98a7nX-TQY3NgsFXk98"
);

/* --- Auth (email OTP) --- */
async function login(){
  const email = document.getElementById('email').value.trim();
  if(!email){ setMsg('authMsg','Enter an email','err'); return; }
  const { error } = await supabase.auth.signInWithOtp({
    email,
    options: { emailRedirectTo: window.location.href }
  });
  setMsg('authMsg', error ? ('Error: '+error.message) : 'Link sent. Open it on this device to finish sign‑in.', error?'err':'ok');
}

supabase.auth.onAuthStateChange((_evt, session) => {
  const signed = !!session;
  document.getElementById('uploader').style.display = signed ? 'block' : 'none';
});

function setMsg(id, text, cls){ const el=document.getElementById(id); el.className=cls||''; el.textContent=text; }
function slugify(s){ return (s||'').toLowerCase().replace(/\s+/g,'_').replace(/[^\w\-\.]/g,''); }
function resetPicker(){ document.getElementById('pickId').innerHTML=''; document.getElementById('searchInput').value=''; }

async function searchNames(){
  const type = document.getElementById('attachType').value;
  const q = document.getElementById('searchInput').value.trim();
  const pick = document.getElementById('pickId');
  pick.innerHTML = '';
  if(!q) return;
  if(type === 'counterparty'){
    let query = supabase.from('counterparties').select('id,name,type').limit(25).order('name');
    query = query.ilike('name', `%${q}%`);
    const { data, error } = await query;
    if(error) return setMsg('msg', error.message, 'err');
    data.forEach(r => { const opt=document.createElement('option'); opt.value=r.id; opt.textContent=`${r.name} (${r.type})`; pick.appendChild(opt); });
  } else {
    let query = supabase.from('procedures').select('id,title').limit(25).order('title');
    query = query.ilike('title', `%${q}%`);
    const { data, error } = await query;
    if(error) return setMsg('msg', error.message, 'err');
    data.forEach(r => { const opt=document.createElement('option'); opt.value=r.id; opt.textContent=r.title; pick.appendChild(opt); });
  }
}

async function doUpload(){
  const type  = document.getElementById('attachType').value;
  const mode  = document.getElementById('conflictMode').value;
  const pick  = document.getElementById('pickId');
  const id    = pick.value;
  const fname = document.getElementById('docName').value.trim();
  const notes = document.getElementById('notes').value.trim();
  const file  = document.getElementById('file').files[0];
  const msg   = document.getElementById('msg');

  if(!id){ msg.innerHTML='<span class="err">Pick a company/procedure.</span>'; return; }
  if(!file){ msg.innerHTML='<span class="err">Choose a file.</span>'; return; }

  const base = (type==='counterparty') ? 'counterparties' : 'procedures';
  const displayName = (fname || file.name).trim();
  const targetName  = slugify(displayName) || slugify(file.name);

  // Decide final storage path based on conflict mode
  let filePath = `${base}/${id}/${targetName}`;
  const { data:list } = await supabase.storage.from('docs').list(`${base}/${id}`, { search: targetName });
  const exists = (list || []).some(x => x.name === targetName);
  if(exists){
    const ext  = targetName.includes('.') ? targetName.slice(targetName.lastIndexOf('.')) : '';
    const stem = ext ? targetName.slice(0, -ext.length) : targetName;
    const stamp = new Date().toISOString().slice(0,10);
    if(mode==='duplicate' || mode==='append'){ filePath = `${base}/${id}/${stem}-${stamp}${ext}`; }
    // overwrite keeps original name/path
  }

  // Upload to 'docs' bucket (NB: supply path without leading 'docs/')
  const { error: upErr } = await supabase.storage.from('docs')
    .upload(filePath, file, { upsert: mode==='overwrite' });
  if(upErr){ msg.innerHTML = `<span class="err">Upload failed: ${upErr.message}</span>`; return; }

  // Record in DB (prefix with 'docs/' for stored path)
  const payload = { name: displayName, storage_path: `docs/${filePath}`, notes: notes || null };
  if(type==='counterparty'){
    payload.counterparty_id = id;
    var { error: insErr } = await supabase.from('counterparty_documents').insert(payload);
  } else {
    payload.procedure_id = id;
    var { error: insErr } = await supabase.from('procedure_documents').insert(payload);
  }
  if(insErr){ msg.innerHTML = `<span class="err">Saved file but DB insert failed: ${insErr.message}</span>`; return; }

  msg.innerHTML = `<span class="ok">Uploaded & saved.</span>`;
  document.getElementById('file').value='';
}
</script>