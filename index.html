<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2575.6">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.7px Arial; -webkit-text-stroke: #000000}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.7px Arial; -webkit-text-stroke: #000000; min-height: 16.0px}
    span.s1 {font-kerning: none}
  </style>
</head>
<body>
<p class="p1"><span class="s1">&lt;!doctype html&gt;</span></p>
<p class="p1"><span class="s1">&lt;meta charset="utf-8"&gt;</span></p>
<p class="p1"><span class="s1">&lt;title&gt;Knowledge Centre — Upload&lt;/title&gt;</span></p>
<p class="p1"><span class="s1">&lt;meta name="viewport" content="width=device-width,initial-scale=1"&gt;</span></p>
<p class="p1"><span class="s1">&lt;style&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:24px;max-width:900px}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>.card{border:1px solid #eee;border-radius:12px;padding:14px;margin:16px 0}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>.row{display:flex;gap:12px;flex-wrap:wrap}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>input,select,textarea,button{padding:10px;border:1px solid #ddd;border-radius:8px}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>input,select,textarea{width:100%}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>button{cursor:pointer;background:#fff}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>label{font-weight:600;margin-top:8px;display:block}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>.muted{opacity:.75}.ok{color:#117a2e}.err{color:#b00020}.small{font-size:.9rem}</span></p>
<p class="p1"><span class="s1">&lt;/style&gt;</span></p>
<p class="p1"><span class="s1">&lt;script src="https://unpkg.com/@supabase/supabase-js@2"&gt;&lt;/script&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">&lt;h1&gt;Upload a document&lt;/h1&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">&lt;div class="card" id="auth"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;p&gt;&lt;strong&gt;Sign in&lt;/strong&gt; with your work email.&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;div class="row"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;input id="email" placeholder="you@company.com"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;button onclick="login()"&gt;Send sign‑in link&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;p class="muted small"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>You’ll receive a magic link; open it on this device. <span class="Apple-converted-space"> </span></span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Make sure this page URL is whitelisted in Supabase → Auth → &lt;em&gt;Additional Redirect URLs&lt;/em&gt;.</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;p id="authMsg"&gt;&lt;/p&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">&lt;div class="card" id="uploader" style="display:none"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;div class="row"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;div style="flex:1;min-width:240px"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;label&gt;Attach to&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;select id="attachType" onchange="resetPicker()"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;option value="counterparty"&gt;Company&lt;/option&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;option value="procedure"&gt;Procedure&lt;/option&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;/select&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;div style="flex:1;min-width:240px"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;label&gt;If filename already exists&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;select id="conflictMode"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;option value="append"&gt;Append (keep both)&lt;/option&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;option value="overwrite"&gt;Overwrite existing&lt;/option&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;option value="duplicate"&gt;Duplicate (add suffix)&lt;/option&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;/select&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;label&gt;Search name&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;input id="searchInput" placeholder="Start typing company or procedure…" oninput="searchNames()"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;div class="muted small"&gt;Pick one below:&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;select id="pickId" size="6" style="width:100%"&gt;&lt;/select&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;label&gt;Document name (how it appears)&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;input id="docName" placeholder="e.g., KYC Form, Master Agreement, Bill of Lading"&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;label&gt;Notes (optional)&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;textarea id="notes" rows="3" placeholder="Any context or expiry date"&gt;&lt;/textarea&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;label&gt;File&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;input id="file" type="file" /&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;div class="row" style="margin-top:12px"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;button onclick="doUpload()"&gt;Upload &amp; save&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;p id="msg"&gt;&lt;/p&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">&lt;script&gt;</span></p>
<p class="p1"><span class="s1">/* Your Supabase project (safe to expose with RLS) */</span></p>
<p class="p1"><span class="s1">const supabase = window.supabase.createClient(</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>"https://pajwufsizrmwkjveywyh.supabase.co",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBhand1ZnNpenJtd2tqdmV5d3loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MjEyNjIsImV4cCI6MjA3MDQ5NzI2Mn0.atSQj2ekJo_fePOOhMjbzRav98a7nX-TQY3NgsFXk98"</span></p>
<p class="p1"><span class="s1">);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">/* --- Auth (email OTP) --- */</span></p>
<p class="p1"><span class="s1">async function login(){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const email = document.getElementById('email').value.trim();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>if(!email){ setMsg('authMsg','Enter an email','err'); return; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const { error } = await supabase.auth.signInWithOtp({</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>email,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>options: { emailRedirectTo: window.location.href }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>setMsg('authMsg', error ? ('Error: '+error.message) : 'Link sent. Open it on this device.', error?'err':'ok');</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">supabase.auth.onAuthStateChange((_evt, session) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>document.getElementById('uploader').style.display = session ? 'block' : 'none';</span></p>
<p class="p1"><span class="s1">});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">function setMsg(id, text, cls){ const el=document.getElementById(id); el.className=cls||''; el.textContent=text; }</span></p>
<p class="p1"><span class="s1">function slugify(s){ return (s||'').toLowerCase().replace(/\s+/g,'_').replace(/[^\w\-.]/g,''); }</span></p>
<p class="p1"><span class="s1">function resetPicker(){ document.getElementById('pickId').innerHTML=''; document.getElementById('searchInput').value=''; }</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">/* --- Search by name (no UUID hunting) --- */</span></p>
<p class="p1"><span class="s1">async function searchNames(){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const type = document.getElementById('attachType').value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const q = document.getElementById('searchInput').value.trim();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const pick = document.getElementById('pickId');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>pick.innerHTML = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>if(!q) return;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>if(type === 'counterparty'){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const { data, error } = await supabase</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>.from('counterparties')</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>.select('id,name,type')</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>.ilike('name', `%${q}%`)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>.order('name')</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>.limit(25);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if(error) return setMsg('msg', error.message, 'err');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>data.forEach(r =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>const o=document.createElement('option');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>o.value=r.id; o.textContent=`${r.name} (${r.type})`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pick.appendChild(o);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const { data, error } = await supabase</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>.from('procedures')</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>.select('id,title')</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>.ilike('title', `%${q}%`)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>.order('title')</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>.limit(25);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if(error) return setMsg('msg', error.message, 'err');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>data.forEach(r =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>const o=document.createElement('option');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>o.value=r.id; o.textContent=r.title;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pick.appendChild(o);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">/* --- Upload &amp; save metadata --- */</span></p>
<p class="p1"><span class="s1">async function doUpload(){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const type<span class="Apple-converted-space">  </span>= document.getElementById('attachType').value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const mode<span class="Apple-converted-space">  </span>= document.getElementById('conflictMode').value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const id<span class="Apple-converted-space">    </span>= document.getElementById('pickId').value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const fname = document.getElementById('docName').value.trim();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const notes = document.getElementById('notes').value.trim();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const file<span class="Apple-converted-space">  </span>= document.getElementById('file').files[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const msg <span class="Apple-converted-space">  </span>= document.getElementById('msg');</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>if(!id){ msg.innerHTML='&lt;span class="err"&gt;Pick a company/procedure first.&lt;/span&gt;'; return; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>if(!file){ msg.innerHTML='&lt;span class="err"&gt;Choose a file.&lt;/span&gt;'; return; }</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const base = (type==='counterparty') ? 'counterparties' : 'procedures';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const displayName = (fname || file.name).trim();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const targetName<span class="Apple-converted-space">  </span>= slugify(displayName) || slugify(file.name);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Decide storage path based on conflict handling</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>let objectPath = `${base}/${id}/${targetName}`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const { data:list } = await supabase.storage.from('docs').list(`${base}/${id}`, { search: targetName });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const exists = (list || []).some(x =&gt; x.name === targetName);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>if(exists){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const ext<span class="Apple-converted-space">  </span>= targetName.includes('.') ? targetName.slice(targetName.lastIndexOf('.')) : '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const stem = ext ? targetName.slice(0, -ext.length) : targetName;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const stamp = new Date().toISOString().slice(0,10);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if(mode==='duplicate' || mode==='append'){ objectPath = `${base}/${id}/${stem}-${stamp}${ext}`; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// overwrite keeps same name</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Upload to Storage (bucket 'docs'); objectPath is WITHOUT 'docs/' prefix</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const { error: upErr } = await supabase.storage.from('docs')</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>.upload(objectPath, file, { upsert: mode==='overwrite' });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>if(upErr){ msg.innerHTML = `&lt;span class="err"&gt;Upload failed: ${upErr.message}&lt;/span&gt;`; return; }</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Save metadata row</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const storage_path = `docs/${objectPath}`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const payload = { name: displayName, storage_path, notes: notes || null };</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>let ins;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>if(type==='counterparty'){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>payload.counterparty_id = id;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ins = await supabase.from('counterparty_documents').insert(payload);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>payload.procedure_id = id;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ins = await supabase.from('procedure_documents').insert(payload);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>if(ins.error){ msg.innerHTML = `&lt;span class="err"&gt;Saved file but DB insert failed: ${ins.error.message}&lt;/span&gt;`; return; }</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>msg.innerHTML = `&lt;span class="ok"&gt;Uploaded and saved ✔&lt;/span&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>document.getElementById('file').value='';</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">&lt;/script&gt;</span></p>
</body>
</html>
